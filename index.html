<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calibration Reminder System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
    }
    h1, h2 {
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .form-container, .table-container, .log-container {
      margin-bottom: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="text"], input[type="number"], input[type="date"], select {
      flex: 1;
      min-width: 200px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .status {
      margin-bottom: 20px;
    }
    @media (max-width: 600px) {
      input, select, button {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calibration Reminder System</h1>

    <!-- Status Section -->
    <div class="status">
      <h2>Status</h2>
      <p>Due Soon: <span id="due-soon">0</span></p>
      <p>Overdue: <span id="overdue">0</span></p>
      <p>Not Due: <span id="not-due">0</span></p>
    </div>

    <!-- Calibration Form -->
    <div class="form-container">
      <h2>Add/Edit Calibration</h2>
      <form id="calibration-form">
        <input type="hidden" id="id">
        <input type="text" id="equipment-name" placeholder="Equipment Name" required>
        <input type="text" id="make" placeholder="Make" required>
        <input type="text" id="manufactured" placeholder="Manufactured" required>
        <input type="text" id="serial-number" placeholder="Serial Number" required>
        <input type="date" id="calibration-date" required>
        <input type="number" id="number-of-instruments" placeholder="Number of Instruments" required>
        <select id="department" required>
          <option value="">Select Department</option>
        </select>
        <input type="text" id="emails" placeholder="Team Emails (comma-separated)" required>
        <input type="number" id="recalibration-interval" placeholder="Interval (months)" required>
        <button type="submit">Save</button>
        <button type="button" id="clear-form">Clear Form</button>
      </form>
      <p class="error" id="form-error"></p>
    </div>

    <!-- Calibration Data Table -->
    <div class="table-container">
      <h2>Calibration Data</h2>
      <button onclick="sendReminders()">Send Reminders</button>
      <button onclick="downloadData()">Download Data</button>
      <button onclick="clearAllData()">Clear All Data</button>
      <input type="file" id="csv-file" accept=".csv">
      <button onclick="uploadCSV()">Upload CSV</button>
      <table id="calibration-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Equipment Name</th>
            <th>Make</th>
            <th>Manufactured</th>
            <th>Serial Number</th>
            <th>Calibration Date</th>
            <th>Number of Instruments</th>
            <th>Department</th>
            <th>Team Emails</th>
            <th>Interval (months)</th>
            <th>Last Reminder</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Departments Section -->
    <div class="form-container">
      <h2>Manage Departments</h2>
      <form id="department-form">
        <input type="text" id="dept-name" placeholder="Department Name" required>
        <input type="text" id="dept-emails" placeholder="Emails (comma-separated)" required>
        <button type="submit">Add Department</button>
      </form>
      <table id="department-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Emails</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="saveDepartments()">Save Departments</button>
      <p class="error" id="dept-error"></p>
    </div>

    <!-- Email Log Section -->
    <div class="log-container">
      <h2>Email Log</h2>
      <table id="email-log-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Equipment Name</th>
            <th>Emails</th>
            <th>Type</th>
            <th>Success</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Missing Instruments Section -->
    <div class="table-container">
      <h2>Overdue Instruments</h2>
      <button onclick="downloadMissing()">Download Overdue</button>
      <table id="missing-table">
        <thead>
          <tr>
            <th>Equipment Name</th>
            <th>Due Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    async function fetchData() {
      try {
        const response = await fetch('/api/data');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch data');
        populateTable(data);
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function fetchStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch status');
        document.getElementById('due-soon').textContent = data.due_soon;
        document.getElementById('overdue').textContent = data.overdue;
        document.getElementById('not-due').textContent = data.not_due;
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function fetchDepartments() {
      try {
        const response = await fetch('/api/departments');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch departments');
        populateDepartmentDropdown(data);
        populateDepartmentTable(data);
      } catch (err) {
        document.getElementById('dept-error').textContent = err.message;
      }
    }

    async function fetchEmailLog() {
      try {
        const response = await fetch('/api/email_log');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch email log');
        populateEmailLogTable(data);
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function fetchMissing() {
      try {
        const response = await fetch('/api/missing');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch missing instruments');
        populateMissingTable(data);
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    function populateTable(data) {
      const tbody = document.querySelector('#calibration-table tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.equipment_name}</td>
          <td>${row.make}</td>
          <td>${row.manufactured}</td>
          <td>${row.serial_number}</td>
          <td>${row.calibration_date}</td>
          <td>${row.number_of_instruments}</td>
          <td>${row.department}</td>
          <td>${row.emails}</td>
          <td>${row.recalibration_interval}</td>
          <td>${row.last_reminder ? new Date(row.last_reminder * 1000).toLocaleString() : ''}</td>
          <td>
            <button onclick="editRow('${row.id}')">Edit</button>
            <button onclick="deleteRow('${row.id}')">Delete</button>
            <button onclick="sendEmail('${row.id}')">Send Email</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateDepartmentDropdown(departments) {
      const select = document.getElementById('department');
      select.innerHTML = '<option value="">Select Department</option>';
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.name;
        option.textContent = dept.name;
        select.appendChild(option);
      });
    }

    function populateDepartmentTable(departments) {
      const tbody = document.querySelector('#department-table tbody');
      tbody.innerHTML = '';
      departments.forEach(dept => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${dept.name}</td>
          <td>${dept.emails}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateEmailLogTable(logs) {
      const tbody = document.querySelector('#email-log-table tbody');
      tbody.innerHTML = '';
      logs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(log.timestamp * 1000).toLocaleString()}</td>
          <td>${log.equipment_name}</td>
          <td>${log.emails}</td>
          <td>${log.type}</td>
          <td>${log.success ? 'Yes' : 'No'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateMissingTable(data) {
      const tbody = document.querySelector('#missing-table tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.equipment_name}</td>
          <td>${row.due_date}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function saveCalibration(event) {
      event.preventDefault();
      const form = document.getElementById('calibration-form');
      const error = document.getElementById('form-error');
      error.textContent = '';

      const data = {
        id: document.getElementById('id').value || Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        equipment_name: document.getElementById('equipment-name').value,
        make: document.getElementById('make').value,
        manufactured: document.getElementById('manufactured').value,
        serial_number: document.getElementById('serial-number').value,
        calibration_date: document.getElementById('calibration-date').value,
        number_of_instruments: document.getElementById('number-of-instruments').value,
        department: document.getElementById('department').value,
        emails: document.getElementById('emails').value,
        recalibration_interval: document.getElementById('recalibration-interval').value,
      };

      try {
        const method = data.id ? 'PUT' : 'POST';
        const response = await fetch('/api/data', {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to save data');
        form.reset();
        document.getElementById('id').value = '';
        await fetchData();
        await fetchStatus();
      } catch (err) {
        error.textContent = err.message;
      }
    }

    async function editRow(id) {
      try {
        const response = await fetch('/api/data');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to fetch data');
        const row = data.find(item => item.id === id);
        if (row) {
          document.getElementById('id').value = row.id;
          document.getElementById('equipment-name').value = row.equipment_name;
          document.getElementById('make').value = row.make;
          document.getElementById('manufactured').value = row.manufactured;
          document.getElementById('serial-number').value = row.serial_number;
          document.getElementById('calibration-date').value = row.calibration_date;
          document.getElementById('number-of-instruments').value = row.number_of_instruments;
          document.getElementById('department').value = row.department;
          document.getElementById('emails').value = row.emails;
          document.getElementById('recalibration-interval').value = row.recalibration_interval;
        }
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function deleteRow(id) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      try {
        const response = await fetch('/api/data', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }),
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to delete data');
        await fetchData();
        await fetchStatus();
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function sendEmail(id) {
      try {
        const response = await fetch(`/api/send-email/${id}`, {
          method: 'POST',
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to send email');
        alert('Email sent successfully');
        await fetchData();
        await fetchEmailLog();
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function sendReminders() {
      try {
        const response = await fetch('/api/send_reminders', {
          method: 'POST',
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to send reminders');
        alert('Reminders processed');
        await fetchData();
        await fetchEmailLog();
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function downloadData() {
      try {
        const response = await fetch('/api/data?download=true');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to download data');
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'calibration_data.json';
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function downloadMissing() {
      try {
        const response = await fetch('/api/missing?download=true');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to download missing instruments');
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'overdue_instruments.json';
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function clearAllData() {
      if (!confirm('Are you sure you want to clear all calibration data?')) return;
      try {
        const response = await fetch('/api/data', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ all: true }),
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to clear data');
        await fetchData();
        await fetchStatus();
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function uploadCSV() {
      const fileInput = document.getElementById('csv-file');
      if (!fileInput.files.length) {
        document.getElementById('form-error').textContent = 'Please select a CSV file';
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('send_emails', 'true');
      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to upload CSV');
        alert(result.message);
        await fetchData();
        await fetchStatus();
        await fetchEmailLog();
        fileInput.value = '';
      } catch (err) {
        document.getElementById('form-error').textContent = err.message;
      }
    }

    async function addDepartment(event) {
      event.preventDefault();
      const name = document.getElementById('dept-name').value;
      const emails = document.getElementById('dept-emails').value;
      const error = document.getElementById('dept-error');
      error.textContent = '';

      try {
        const response = await fetch('/api/departments');
        const departments = await response.json();
        if (!response.ok) throw new Error(departments.error || 'Failed to fetch departments');
        departments.push({ name, emails });
        document.getElementById('department-form').reset();
        populateDepartmentDropdown(departments);
        populateDepartmentTable(departments);
      } catch (err) {
        error.textContent = err.message;
      }
    }

    async function saveDepartments() {
      const tbody = document.querySelector('#department-table tbody');
      const departments = Array.from(tbody.rows).map(row => ({
        name: row.cells[0].textContent,
        emails: row.cells[1].textContent,
      }));
      try {
        const response = await fetch('/api/departments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(departments),
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to save departments');
        alert('Departments saved');
        await fetchDepartments();
      } catch (err) {
        document.getElementById('dept-error').textContent = err.message;
      }
    }

    document.getElementById('calibration-form').addEventListener('submit', saveCalibration);
    document.getElementById('department-form').addEventListener('submit', addDepartment);
    document.getElementById('clear-form').addEventListener('click', () => {
      document.getElementById('calibration-form').reset();
      document.getElementById('id').value = '';
      document.getElementById('form-error').textContent = '';
    });

    // Initial data load
    fetchData();
    fetchStatus();
    fetchDepartments();
    fetchEmailLog();
    fetchMissing();
  </script>
</body>
</html>
